'use strict';

const Model = require('../Model');
const Joi = require('joi');
const bcrypt = require('bcrypt');

/**
 * This represents an authentication model
 */
class Authentication extends Model {
  // Name of database table for this model
  static get tableName() {
    return 'authentications';
  }

  // If this is true only properties in jsonSchema are picked when inserting or updating a row in the database.
  static get pickJsonSchemaProperties() {
    return true;
  }

  static get joiAuthorityIdValidation() {
    return Joi.number()
      .integer()
      .positive()
      .allow(null);
  }

  static get joiEmailValidation() {
    return Joi.string()
      .min(5)
      .max(250)
      .email();
  }

  static get joiPasswordValidation() {
    return Joi.string()
      .min(8)
      .max(60);
  }

  // Encrypt password
  $beforeInsert() {
    super.$beforeInsert();

    this.password = bcrypt.hashSync(this.password, 10);
  }

  $beforeUpdate() {
    super.$beforeUpdate();

    if (typeof this.password !== 'undefined') {
      this.password = bcrypt.hashSync(this.password, 10);
    }
  }

  $formatJson(json) {
    delete json.password;

    json = super.$formatJson(json);

    return json;
  }

  // Gets the joi schema for registration and create route validation
  static get joiSchema() {
    return Joi.object().keys({
      authority_id: this.joiAuthorityIdValidation.optional(),
      email: this.joiEmailValidation.required(),
      password: this.joiPasswordValidation.required(),
    });
  }

  // Gets the joi schema for update route validation
  static get joiPatchSchema() {
    return Joi.object().keys({
      authority_id: this.joiAuthorityIdValidation.optional(),
      email: this.joiEmailValidation.optional(),
      password: this.joiPasswordValidation.optional(),
    });
  }

  // Gets the joi schema for authenticate route validation
  static get joiAuthenticateSchema() {
    return Joi.object().keys({
      email: Joi.string().required(),
      password: Joi.string().required(),
    });
  }

  // Optional schema against which the JSON is validated
  static get jsonSchema() {
    return {
      // Type for this model
      type: 'object',

      // Required fields
      required: ['email', 'password'],

      // Property validation when creating the object
      properties: {
        authority_id: {
          type: ['number', null],
        },
        email: {
          type: 'string',
          minLength: 5,
          maxLength: 250,
        },
        password: {
          type: 'string',
          minLenth: 8,
        },
        created_at: {
          type: 'string',
        },
        updated_at: {
          type: 'string',
        },
      },
    };
  }
}

module.exports = Authentication;
